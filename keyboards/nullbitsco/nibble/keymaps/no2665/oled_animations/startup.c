#include QMK_KEYBOARD_H
#include "animation_observer.h"
#include OLED_FONT_H

uint16_t startup_timer;

#define STARTUP_DELAY 1000

/**
 *
 */
void render_logo(void) {
    static const char logo[] PROGMEM = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xe0, 0xe0, 0xc0, 0x80, 0xc0, 0xc0, 0xc0,
0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0x80, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x01, 0x03, 0x03, 0x03,
0x03, 0x03, 0x03, 0x07, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x3f, 0x7f, 0x7f, 0x3f, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x3f, 0x7f, 0x7f, 0x3f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0xf8, 0x30, 0xc0, 0xf8, 0x00, 0x08, 0xf8, 0x08, 0x00, 0xf8, 0x28, 0x28, 0xd0, 0x00,
0xf8, 0x28, 0x28, 0xd0, 0x00, 0xf8, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x28, 0x28, 0x28, 0x00, 0x00,
0x00, 0x00, 0x01, 0x00, 0x00, 0x01, 0x00, 0x01, 0x01, 0x01, 0x00, 0xe1, 0xa1, 0xa1, 0x40, 0x00,
0xc1, 0x01, 0x01, 0xc0, 0x00, 0x01, 0x01, 0x01, 0x01, 0x00, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x04, 0x04, 0x03, 0x00,
0x11, 0x1e, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x3e, 0x02, 0x06, 0x38, 0x00, 0x3e, 0x20, 0x3e, 0x00, 0x00, 0x3f, 0x00, 0x3f, 0x00,
0x3f, 0x22, 0x22, 0x3e, 0x00, 0x3d, 0x00, 0x1f, 0x22, 0x22, 0x04, 0x2a, 0x2a, 0x10, 0x00, 0x00
    };
    oled_set_cursor(0, 9);
    oled_write_raw_P(logo, sizeof(logo));
}

void render_hand(void) {
    static const char hand[] PROGMEM = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0x04, 0x04, 0xfe,
0x01, 0x01, 0xfe, 0x04, 0x04, 0xf8, 0x20, 0x20, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7e, 0x81, 0x01, 0x0e, 0x10, 0x3f, 0x00, 0x00, 0x0f,
0x00, 0x00, 0x0f, 0x00, 0x00, 0x3f, 0x00, 0x00, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x06, 0x18, 0x20, 0x20, 0x40, 0x41, 0x41,
0x41, 0x62, 0x5c, 0x40, 0x40, 0x20, 0x18, 0x06, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };
    oled_set_cursor(0, 2);
    oled_write_raw_P(hand, sizeof(hand));
}

void render_hand_right(void) {
    static const char hand_right[] PROGMEM = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x40, 0x40, 0x80, 0x00, 0x00, 0xc0,
0x70, 0x08, 0x88, 0x70, 0x08, 0x84, 0xe4, 0x18, 0x20, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0x00, 0x00, 0x07, 0x18, 0x0e, 0x01,
0x00, 0x1c, 0x03, 0x00, 0x1c, 0x03, 0xe0, 0x38, 0x07, 0xc1, 0x32, 0x0c, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x18, 0x20, 0x20, 0x40, 0x41, 0xe1,
0xa6, 0x98, 0x80, 0x80, 0x40, 0x20, 0x20, 0x10, 0x0e, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };
    oled_set_cursor(0, 2);
    oled_write_raw_P(hand_right, sizeof(hand_right));
}

void render_hand_left(void) {
    static const char hand_left[] PROGMEM = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x40, 0x70, 0x88, 0x08, 0x30, 0x60, 0x90, 0x10, 0x20,
0xc0, 0x40, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x60, 0x90, 0x10, 0x20, 0x41, 0x86, 0x98, 0x60, 0x83, 0x1c, 0x20, 0x01, 0x0e, 0x10,
0x01, 0x0e, 0x30, 0x00, 0x07, 0x38, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x01, 0x02, 0x04, 0x08, 0x10, 0x21, 0x21, 0x40, 0x44, 0x84, 0x82, 0x82,
0x84, 0x64, 0x58, 0x40, 0x20, 0x1c, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };
    oled_set_cursor(0, 2);
    oled_write_raw_P(hand_left, sizeof(hand_left));
}

bool oled_task_animation_startup(void) {
    static bool finished = false;
    if ( finished ) {
        return false;
    }
    static uint8_t hand_state = 0;
    /*static uint8_t total_pans = 0;
    if ( total_pans > oled_get_display_height() ) {
        return false;
    }

    uint16_t now = timer_read();
    if ( now > STARTUP_DELAY ) {
        if ( now - startup_timer > 50 ) {
            //oled_pan_down();
            startup_timer = now;
            total_pans += 1;
        }
    }*/

    uint16_t now = timer_read();
    if ( now - startup_timer > 400 ) {
        switch ( hand_state % 4 ) {
            case 0:
                render_hand_right();
                break;
            case 1:
            case 3:
                render_hand();
                break;
            case 2:
                render_hand_left();
                break;
        }
        hand_state += 1;
        startup_timer = now;
        if ( hand_state > 12 ) {
            finished = true;
            set_flag_can_render( true );
        }
    }
    return true;
}

void keyboard_post_init_animation_startup(void) {
    render_logo();
    render_hand();
    startup_timer = timer_read();
}

AnimationObserver* create_startup_animation(void) {
    AnimationObserver* startup = malloc(sizeof(AnimationObserver));
    if ( startup != NULL ) {
        startup->processRecordOled = NULL;
        startup->oledTaskUser = oled_task_animation_startup;
        startup->oledInitUser = NULL;
        startup->keyboardPostInitUser = keyboard_post_init_animation_startup;
    }
    return startup;
}
